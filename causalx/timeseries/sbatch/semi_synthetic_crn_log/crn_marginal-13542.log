[2024-09-26 02:17:37 +0000] [1470421] [INFO] Starting gunicorn 22.0.0
[2024-09-26 02:17:37 +0000] [1470421] [INFO] Listening at: http://127.0.0.1:6002 (1470421)
[2024-09-26 02:17:37 +0000] [1470421] [INFO] Using worker: sync
[2024-09-26 02:17:37 +0000] [1470429] [INFO] Booting worker with pid: 1470429
[2024-09-26 02:17:37 +0000] [1470430] [INFO] Booting worker with pid: 1470430
[2024-09-26 02:17:37 +0000] [1470431] [INFO] Booting worker with pid: 1470431
[2024-09-26 02:17:37 +0000] [1470432] [INFO] Booting worker with pid: 1470432
runnables/train_enc_dec.py:18: UserWarning: 
The version_base parameter is not specified.
Please specify a compatability version level, or None.
Will assume defaults for version 1.1
  @hydra.main(config_name=f'config.yaml', config_path='../config/')
[[36m2024-09-26 02:17:50,001[0m][[34m__main__[0m][[32mINFO[0m] - 
model:
  dim_treatments: ???
  dim_vitals: ???
  dim_static_features: ???
  dim_outcomes: ???
  name: CRN
  encoder:
    _target_: src.models.crn.CRNEncoder
    seq_hidden_units: 74
    br_size: 74
    fc_hidden_units: 37
    dropout_rate: 0.1
    num_layer: 1
    batch_size: 64
    optimizer:
      optimizer_cls: adam
      learning_rate: 0.001
      weight_decay: 0.0
      lr_scheduler: false
    tune_hparams: false
    tune_range: 50
    hparams_grid: null
    resources_per_trial: null
  train_decoder: true
  decoder:
    _target_: src.models.crn.CRNDecoder
    seq_hidden_units: null
    br_size: 98
    fc_hidden_units: 98
    dropout_rate: 0.1
    num_layer: 2
    batch_size: 256
    optimizer:
      optimizer_cls: adam
      learning_rate: 0.0001
      weight_decay: 0.0
      lr_scheduler: false
    tune_hparams: false
    tune_range: 30
    hparams_grid: null
    resources_per_trial: null
dataset:
  val_batch_size: 512
  treatment_mode: multilabel
  _target_: src.data.MIMIC3SyntheticDatasetCollection
  seed: 10
  name: mimic3_synthetic
  path: data/processed/all_hourly_data.h5
  min_seq_length: 20
  max_seq_length: 100
  max_number: 1000
  data_seed: 10
  projection_horizon: 10
  n_treatments_seq: 10
  split:
    val: 0.2
    test: 0.2
  autoregressive: true
  vital_list:
  - heart rate
  - red blood cell count
  - sodium
  - mean blood pressure
  - systemic vascular resistance
  - glucose
  - chloride urine
  - glascow coma scale total
  - hematocrit
  - positive end-expiratory pressure set
  - respiratory rate
  - prothrombin time pt
  - cholesterol
  - hemoglobin
  - creatinine
  - blood urea nitrogen
  - bicarbonate
  - calcium ionized
  - partial pressure of carbon dioxide
  - magnesium
  - anion gap
  - phosphorous
  - venous pvo2
  - platelets
  - calcium urine
  static_list:
  - gender
  - ethnicity
  - age
  drop_first: false
  synth_outcomes_list:
  - _target_: src.data.mimic_iii.SyntheticOutcomeGenerator
    exogeneous_vars:
    - heart rate
    - glucose
    - sodium
    exog_dependency:
      _target_: src.data.mimic_iii.utils.RandomFourierFeaturesFunction
      input_dim: 3
      gamma: 0.005
      scale: 40.0
    exog_weight: 0.9
    endo_dependency:
      _target_: src.data.mimic_iii.utils.DiscretizedRandomGPFunction
      kernels:
      - _target_: sklearn.gaussian_process.kernels.Matern
        length_scale: 25.0
        nu: 2.5
      - _target_: sklearn.gaussian_process.kernels.WhiteKernel
        noise_level: 0.005
    endo_rand_weight: 0.4
    endo_spline_weight: 2.0
    outcome_name: y1
  - _target_: src.data.mimic_iii.SyntheticOutcomeGenerator
    exogeneous_vars:
    - heart rate
    - glucose
    - anion gap
    exog_dependency:
      _target_: src.data.mimic_iii.utils.RandomFourierFeaturesFunction
      input_dim: 3
      gamma: 0.005
      scale: 40.0
    exog_weight: 1.0
    endo_dependency:
      _target_: src.data.mimic_iii.utils.DiscretizedRandomGPFunction
      kernels:
      - _target_: sklearn.gaussian_process.kernels.Matern
        length_scale: 25.0
        nu: 2.5
      - _target_: sklearn.gaussian_process.kernels.WhiteKernel
        noise_level: 0.001
    endo_rand_weight: 0.5
    endo_spline_weight: 3.5
    outcome_name: y2
  synth_treatments_list:
  - _target_: src.data.mimic_iii.SyntheticTreatment
    confounding_vars:
    - blood urea nitrogen
    - glucose
    - sodium
    confounder_outcomes:
    - y1
    confounding_dependency:
      _target_: src.data.mimic_iii.utils.RandomFourierFeaturesFunction
      input_dim: 3
      gamma: 0.01
      scale: 30.0
    window: 3
    conf_outcome_weight: 2.5
    conf_vars_weight: 2.5
    bias: 0.0
    full_effect: -1.0
    effect_window: 20
    treatment_name: t1
  - _target_: src.data.mimic_iii.SyntheticTreatment
    confounding_vars:
    - systemic vascular resistance
    - bicarbonate
    - anion gap
    confounder_outcomes:
    - y1
    - y2
    confounding_dependency:
      _target_: src.data.mimic_iii.utils.RandomFourierFeaturesFunction
      input_dim: 3
      gamma: 0.01
      scale: 30.0
    window: 3
    conf_outcome_weight: 2.0
    conf_vars_weight: 0.25
    bias: 1.0
    full_effect: -1.0
    effect_window: 20
    treatment_name: t2
  - _target_: src.data.mimic_iii.SyntheticTreatment
    confounding_vars:
    - chloride urine
    - glucose
    - sodium
    - systemic vascular resistance
    - magnesium
    - anion gap
    confounder_outcomes:
    - y2
    confounding_dependency:
      _target_: src.data.mimic_iii.utils.RandomFourierFeaturesFunction
      input_dim: 6
      gamma: 0.01
      scale: 30.0
    window: 20
    conf_outcome_weight: 1.5
    conf_vars_weight: 0.25
    bias: 0.0
    full_effect: -0.75
    effect_window: 7
    treatment_name: t3
  treatment_outcomes_influence:
    y1:
    - t1
    - t2
    y2:
    - t2
    - t3
exp:
  seed: 10
  gpus:
  - 0
  max_epochs: 400
  logging: true
  mlflow_uri: http://127.0.0.1:6002
  unscale_rmse: false
  percentage_rmse: false
  alpha: 0
  update_alpha: true
  alpha_rate: exp
  balancing: marginal
  bce_weight: false
  weights_ema: true
  beta: 0.99
  alpha_wass: 0.0001
  alpha_wass_epoch: false
  alpha_wass_growth: 0.001
  alpha_wass_max: 0.01
  num_timepoints: 99
[0m
/opt/hpcaas/.mounts/fs-08d5b24cdba02ca24/home/yilingliu/CausalTransformer/venv/lib/python3.8/site-packages/hydra/_internal/hydra.py:119: UserWarning: Future Hydra versions will no longer change working directory at job runtime by default.
See https://hydra.cc/docs/1.2/upgrades/1.1_to_1.2/changes_to_job_working_dir/ for more information.
  ret = run_job(
Global seed set to 10
[[36m2024-09-26 02:17:50,088[0m][[34msrc.data.mimic_iii.load_data[0m][[32mINFO[0m] - Loading MIMIC-III dataset from /opt/hpcaas/.mounts/fs-08d5b24cdba02ca24/home/yilingliu/CausalTransformer_avg/data/processed/all_hourly_data.h5.[0m
[[36m2024-09-26 02:18:00,390[0m][[34msrc.data.mimic_iii.load_data[0m][[32mINFO[0m] - Number of patients filtered: 1000.[0m
[[36m2024-09-26 02:18:00,454[0m][[34msrc.data.mimic_iii.semi_synthetic_dataset[0m][[32mINFO[0m] - Simulating untreated outcome y1[0m
[[36m2024-09-26 02:18:00,547[0m][[34msrc.data.mimic_iii.semi_synthetic_dataset[0m][[32mINFO[0m] - Simulating untreated outcome y2[0m
[[36m2024-09-26 02:18:00,606[0m][[34msrc.data.mimic_iii.semi_synthetic_dataset[0m][[32mINFO[0m] - Simulating factual treatments and applying them to outcomes.[0m
  0%|          | 0/600 [00:00<?, ?it/s] 14%|â–ˆâ–        | 86/600 [00:12<01:14,  6.94it/s] 29%|â–ˆâ–ˆâ–Š       | 172/600 [00:32<01:25,  5.03it/s] 43%|â–ˆâ–ˆâ–ˆâ–ˆâ–Ž     | 258/600 [05:01<08:45,  1.54s/it] 57%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹    | 344/600 [07:35<06:59,  1.64s/it] 57%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š    | 345/600 [07:39<07:01,  1.65s/it] 72%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–  | 430/600 [08:44<03:34,  1.26s/it] 86%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ | 516/600 [09:48<01:28,  1.06s/it] 86%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ | 517/600 [09:50<01:28,  1.07s/it]100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 600/600 [09:50<00:00,  1.02it/s][[36m2024-09-26 02:30:31,192[0m][[34msrc.data.mimic_iii.semi_synthetic_dataset[0m][[32mINFO[0m] - Shape of exploded vitals: (600, 100, 25).[0m
[[36m2024-09-26 02:30:31,681[0m][[34msrc.data.mimic_iii.semi_synthetic_dataset[0m][[32mINFO[0m] - Simulating untreated outcome y1[0m
[[36m2024-09-26 02:30:31,748[0m][[34msrc.data.mimic_iii.semi_synthetic_dataset[0m][[32mINFO[0m] - Simulating untreated outcome y2[0m
[[36m2024-09-26 02:30:31,776[0m][[34msrc.data.mimic_iii.semi_synthetic_dataset[0m][[32mINFO[0m] - Simulating factual treatments and applying them to outcomes.[0m

  0%|          | 0/200 [00:00<?, ?it/s] 86%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ | 172/200 [00:02<00:00, 85.70it/s]100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 200/200 [00:02<00:00, 99.62it/s][[36m2024-09-26 02:32:44,348[0m][[34msrc.data.mimic_iii.semi_synthetic_dataset[0m][[32mINFO[0m] - Shape of exploded vitals: (200, 100, 25).[0m
[[36m2024-09-26 02:32:44,353[0m][[34msrc.data.mimic_iii.semi_synthetic_dataset[0m][[32mINFO[0m] - Simulating untreated outcome y1[0m
[[36m2024-09-26 02:32:44,405[0m][[34msrc.data.mimic_iii.semi_synthetic_dataset[0m][[32mINFO[0m] - Simulating untreated outcome y2[0m
[[36m2024-09-26 02:32:44,433[0m][[34msrc.data.mimic_iii.semi_synthetic_dataset[0m][[32mINFO[0m] - Simulating counterfactual_one_step treatments and applying them to outcomes.[0m

  0%|          | 0/200 [00:00<?, ?it/s] 86%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ | 172/200 [00:15<00:02, 11.24it/s]100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 200/200 [00:15<00:00, 13.07it/s][[36m2024-09-26 02:54:28,161[0m][[34msrc.data.mimic_iii.semi_synthetic_dataset[0m][[32mINFO[0m] - Concatenating all the trajectories together.[0m
[[36m2024-09-26 02:54:45,631[0m][[34msrc.data.mimic_iii.semi_synthetic_dataset[0m][[32mINFO[0m] - Shape of exploded vitals: (92760, 100, 25).[0m
[[36m2024-09-26 02:55:37,354[0m][[34msrc.data.mimic_iii.semi_synthetic_dataset[0m][[32mINFO[0m] - Simulating untreated outcome y1[0m
[[36m2024-09-26 02:55:37,458[0m][[34msrc.data.mimic_iii.semi_synthetic_dataset[0m][[32mINFO[0m] - Simulating untreated outcome y2[0m
[[36m2024-09-26 02:55:37,486[0m][[34msrc.data.mimic_iii.semi_synthetic_dataset[0m][[32mINFO[0m] - Simulating counterfactual_treatment_seq treatments and applying them to outcomes.[0m

  0%|          | 0/200 [00:00<?, ?it/s] 43%|â–ˆâ–ˆâ–ˆâ–ˆâ–Ž     | 86/200 [00:00<00:00, 441.06it/s] 43%|â–ˆâ–ˆâ–ˆâ–ˆâ–Ž     | 86/200 [00:14<00:00, 441.06it/s]/opt/hpcaas/.mounts/fs-08d5b24cdba02ca24/home/yilingliu/CausalTransformer/venv/lib/python3.8/site-packages/joblib/externals/loky/process_executor.py:752: UserWarning: A worker stopped while some jobs were given to the executor. This can be caused by a too short worker timeout or by a memory leak.
  warnings.warn(
 86%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ | 172/200 [04:30<00:51,  1.85s/it]100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 200/200 [04:30<00:00,  1.35s/it]/var/spool/slurmd/job13542/slurm_script: line 20: 1470373 Bus error               PYTHONPATH=. python3 runnables/train_enc_dec.py +dataset=mimic3_synthetic +backbone=crn +backbone/crn_hparams/mimic3_synthetic=1000_marginal.yaml exp.seed=10 exp.mlflow_uri=http://127.0.0.1:6002
